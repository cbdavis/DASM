---
title: "DASM Practical 3"
author: "Chris Davis"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Getting started

Make sure to load the `ggplot2` library so we can do plotting.
```{r}
library(ggplot2)
```

# First section: t-test

## Summary of the lecture

t test can be used: 
 
* if sample size >~ 30 (distribution does not matter)
* if sample size <~ 30, only if distribution is normal 


## 4 types of t-test in the lecture: (lower tail, upper tail, two tailed)

### sample t-test
### sample t-test - equal variances
### sample t-test - non-equal variance 
### sample t-test - paired

# Explain the t-test command and the options 

# Practical part - t-test:
  
## One sample test:

Give them a large sample >30 with a certain mean xx 
Make a hypothesis that mu < xx 

then they should do an upper-tailed test
let them use the t.test with upper, two tailed, and lower alternative and observe the p-value  (they might be confused)

let them draw  the t-distribution and add the t-statistic from the sample as vertical line, 

for the upper tail test, the p – values is the area to the left of the line
for the lower tail test, 

lesson: the lower tailed test should never be used if sample mean is smaller than mu   

## One sample test:
For the same test: let them compare the p-value given by the t-test with the p-value from the normal distribution 

take the t-value (this is equivalent to z statistic) and calculate qnorm(t, upper.tail = false), should give a result very close to the p-value by the t-test

## two sample t-test 

2 uncorrelated samples: n ~ 20 from normal distributions with equal variances but different means

Do all three kinds of t-test:

* equal variance
* unequal variance
* paired

what p-values do they observe?

## power of the test 
for the previous example, let them play with the power of the test 
(see power.R for example)

## compare to calculating the power of the test by hand

(see power.R (last part), for example)


# Practical part – bootstrap 
(I still want to discuss if we should introduce the bootstrap package)
It might be useful later for regression etc … 

If not, they can just construct a critical t-value from re-samling the sample like the example in the lecture 
(r-code: bootstrap.R attached)

# (Code to organize into lecture)

## ttest.R

```{r}
non_smoke = c(18,22,21,17,20,17,23,20,22,21)
smoke = c(16,20,14,21,20,18,13,15,17,21)

qqnorm(smoke)
qqline(smoke)
qqnorm(non_smoke)
qqline(non_smoke)

x2 = sd(smoke)
x1 = sd(non_smoke)

t.test(non_smoke, smoke, alternative = "greater", var.equal = FALSE, conf.level = 0.95)
t.test(non_smoke, smoke, alternative = "greater", var.equal = TRUE, conf.level = 0.95)


mean(smoke)
mean(non_smoke)

pre_test = c(77, 56, 64, 60, 57, 53, 72, 62, 65, 66)
post_test = c(88, 74, 83, 68, 58, 50, 67, 64 ,74 ,60)

t.test(pre_test, post_test, alternative = "less", var.equal = FALSE, paired = TRUE, conf.level = 0.95)
t.test(pre_test, post_test, alternative = "less", var.equal = TRUE, conf.level = 0.95)
```

## beta_example.R

```{r}
mu = 30
sig = 10

n1 = 2000
mu_a1 = 30.5
mu_a2 = 35

alpha = 0.05


x = seq(28.5, 36, by = 0.05)
y = dnorm(x, mean = mu, sd = sig/sqrt(n1))
y_a1 = dnorm(x, mu_a1, sig/sqrt(n1))
y_a2 = dnorm(x, mu_a2, sig/sqrt(n1))

x_star = qnorm(1-alpha, mu, sig/sqrt(n1))
power_a1 = 1- pnorm (x_star, mu_a1, sig/sqrt(n1))
z = data.frame(x,y,y_a1,y_a2)

line = data.frame(dist = c(x_star,mu,mu_a1,mu_a2), type = c("a", "b", "c", "d"), 
                  type1 = c("a", "b", "b", "b"))


plot1 <- ggplot(z) + geom_line(aes(x,y)) + geom_line(aes(x, y_a1), color = "green") + 
        geom_line(aes(x, y_a2), color = "purple") 

plot1 <- plot1 + geom_vline(data = line, aes(xintercept = dist,
        color = type, size = type1)) + scale_color_manual(values = c("blue", "black", "green", "purple")) + 
        scale_size_manual(values = c(0.5, 1)) +
        xlab(expression(bar(x)))
  
plot1 <- plot1 + theme_classic() + theme(axis.text = element_text(size = 18, color = "black")) + 
         theme(axis.title = element_text(size = 20, color = "black"))
plot1

```

## power.R

```{r}
x0 = 28
xa = seq(28.5, 33, by = 0.5)
n = 20


sigma = 5
alpha = 0.05

diff = xa - x0

delta = abs(x0-xa)/sigma*sqrt(n)

res = power.t.test(delta = diff, sd = sigma, sig.level = alpha, n = n, 
                   type = "one.sample", alt = "one.sided")
beta1 = 1- res$power

frame = data.frame(xa, power = res$power)

plot1 = ggplot(frame, aes(xa, power)) + geom_point(aes(size = 2)) + ggtitle("n = 20") +
        theme_classic() + theme(axis.text = element_text(size = 18, color = "black")) + 
        theme(axis.title = element_text(size = 20, color = "black")) + 
        theme(legend.position="none")

#second plot

x0 = 28
xa = 30
n = seq(10,100, by = 10)


sigma = 5
alpha = 0.05

diff = xa - x0

delta = abs(x0-xa)/sigma*sqrt(n)

res = power.t.test(delta = diff, sd = sigma, sig.level = alpha, n = n, 
                   type = "one.sample", alt = "one.sided")
beta1 = 1- res$power

frame = data.frame(n, power = res$power)

plot2 = ggplot(frame, aes(n, power)) + geom_point(aes(size = 2)) + ggtitle("mua = 30") +
  theme_classic() + theme(axis.text = element_text(size = 18, color = "black")) + 
  theme(axis.title = element_text(size = 20, color = "black")) + 
  theme(legend.position="none")


plot1
plot2

# by hand
x0 = 0.3
x_bar = 0.456
xa = 0.45
s = 0.2128
n = 9

sigma = 0.25

alpha = 0.01
t_star = qt(1-alpha, n-1)

t = (x_bar - x0)/s*sqrt(n)

beta1 = pt(t_star, n-1, ncp = abs(x0-xa)/sigma*sqrt(n))


```